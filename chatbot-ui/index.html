<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Data Agent</title>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1093.0.min.js"></script>
    <style>
        /* --- ALL STYLE CHANGES ARE HERE --- */
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; height: 100vh; }
        /* 1. Wider Chat Window */
        #chat-container { width: 800px; height: 90vh; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #chat-header { background-color: #232f3e; color: white; padding: 15px; border-top-left-radius: 8px; border-top-right-radius: 8px; text-align: center; font-size: 1.2em; }
        #messages { flex: 1; padding: 15px; overflow-y: auto; border-bottom: 1px solid #ccc; }
        .message { margin-bottom: 15px; display: flex; }
        .user-message { justify-content: flex-end; }
        .bot-message { justify-content: flex-start; }
        .message p { display: inline-block; padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.4; }
        .user-message p { background-color: #007bff; color: white; }
        .bot-message p { background-color: #e9e9eb; color: black; }
        /* 8. Progress Indicator (typing dots) Styling */
        .typing-indicator { display: none; align-items: center; }
        .typing-indicator span { height: 8px; width: 8px; background-color: #999; border-radius: 50%; display: inline-block; margin: 0 2px; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        #input-container { display: flex; padding: 10px; }
        #chat-input { flex: 1; border: 1px solid #ccc; border-radius: 18px; padding: 10px 15px; font-size: 1em; }
        #send-button { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 10px; cursor: pointer; font-size: 1.5em; line-height: 40px; text-align: center;}
        #send-button:hover { background-color: #0056b3; }
        #send-button:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-header">AI Data Agent</div>
        <div id="messages">
            <!-- 3 & 4. New Welcome Messages -->
            <div class="message bot-message"><p>Hi there! ðŸ‘‹ Iâ€™m your AI Data Agent, trained on World Bankâ€™s World Development Indicators (demo mode with ~250 indicators). Ask me about an indicator for a country and year, and Iâ€™ll give you a quick text answer. For the bigger requests , Iâ€™ll generate an Excel file you can download. Some of the newest data may not be available yet, so try to be specificâ€”and thanks for your patience while I fetch results!</p></div>
            <div class="message bot-message"><p>How can I help you?</p></div>
            <!-- 8. Progress Indicator HTML -->
            <div class="message bot-message typing-indicator" id="typing-indicator">
                <p><span></span><span></span><span></span></p>
            </div>
        </div>
        <div id="input-container">
            <input type="text" id="chat-input" placeholder="Type your message..." />
            <button id="send-button">&#10148;</button>
        </div>
    </div>

    <script>
        // --- START CONFIGURATION ---
        const AWS_REGION = "us-west-2";
        const COGNITO_IDENTITY_POOL_ID = "us-west-2:f6fc8a4d-3cab-4f05-8810-49ce372bb3ce"; // <-- MAKE SURE THIS IS YOUR ID
        const LEX_BOT_ID = "65EGNPKM8A"; // <-- PASTE YOUR BOT ID HERE
        const LEX_BOT_ALIAS_ID = "TSTALIASID"; 
        // --- END CONFIGURATION ---

        AWS.config.region = AWS_REGION;
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({ IdentityPoolId: COGNITO_IDENTITY_POOL_ID });
        const lexruntime = new AWS.LexRuntimeV2();

        const sessionId = "WebAppSession-" + new Date().getTime();
        const messagesDiv = document.getElementById('messages');
        const input = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');

        function addMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${sender}-message`);
            const p = document.createElement('p');
            if (typeof message === 'string') {
                p.textContent = message;
            } else if (message.contentType === 'CustomPayload') {
                p.innerHTML = message.content;
            } else {
                p.innerHTML = (message.content || '').replace(/\n/g, '<br>');
            }
            messageDiv.appendChild(p);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const inputText = input.value.trim();
            if (inputText === '') return;

            addMessage(inputText, 'user');
            input.value = '';
            
            // 8. Show progress indicator and disable input
            messagesDiv.appendChild(typingIndicator);
            typingIndicator.style.display = 'flex';
            sendButton.disabled = true;
            input.disabled = true;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;


            const params = {
                botId: LEX_BOT_ID,
                botAliasId: LEX_BOT_ALIAS_ID,
                localeId: 'en_US',
                sessionId: sessionId,
                text: inputText,
            };

            lexruntime.recognizeText(params, function (err, data) {
                // 8. Hide progress indicator and re-enable input
                typingIndicator.style.display = 'none';
                sendButton.disabled = false;
                input.disabled = false;
                input.focus(); // Set focus back to the input box

                if (err) {
                    console.error(err, err.stack);
                    addMessage(`Error: ${err.message || 'Could not connect to the bot.'}`, 'bot');
                } else {
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => addMessage(msg, 'bot'));
                    } else {
                         addMessage("I'm sorry, I didn't get a response. Please try again.", 'bot');
                    }
                }
            });
        }

        sendButton.addEventListener('click', sendMessage);
        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>